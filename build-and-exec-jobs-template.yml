jobs:
  - ${{ each execTest in parameters.execTests }}:
      - job:

        displayName: ${{execTest.displayName}}
        
        pool:
          vmImage: ${{execTest.vmImage}}


        variables:
          currentImage: ${{execTest.vmImage}}
          VERSION:
          JAVA_TOOL_OPTIONS: ${{execTest.javaToolOptions}}

        steps:

          # Runs 'mvn clean package'
          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              mavenOptions: '-Xmx3072m'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '${{execTest.jdkVersion}}'
              jdkArchitectureOption: 'x64'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              goals: 'package'

          - task: Bash@3
            inputs:
            targetType: 'inline'
            script: mkdir -p $(Pipeline.Workspace)/target-ig; git clone https://github.com/FHIR/fhir-tools-ig.git $(Pipeline.Workspace)/target-ig

          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              mavenOptions: '-Xmx3072m'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '${{execTest.jdkVersion}}'
              jdkArchitectureOption: 'x64'
              options: '-pl org.hl7.fhir.publisher.cli'
              publishJUnitResults: false
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              goals: 'exec:exec'